<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facility Booking Frequency</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .controls { margin-bottom: 1rem; }
    .controls button { margin-right: .5rem; }
    #chartContainer { width: 80%; max-width: 600px; margin: 2rem auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: .5rem; text-align: left; }
  </style>

  <!-- jsPDF & AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Facility Booking Frequency</h1>
  <div class="controls">
    <button id="refreshBtn">Refresh Data</button>
    <button id="exportCsvBtn">Export CSV</button>
    <button id="exportChartPngBtn">Export Chart PNG</button>
    <button id="exportPdfBtn">Export PDF</button>
  </div>

  <div id="chartContainer">
    <canvas id="barChart"></canvas>
  </div>

  <table id="freqTable">
    <thead>
      <tr><th>Facility ID</th><th>Times Booked</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = 'https://backend-k52m.onrender.com/bookings?status=approved';

    // Initialize Chart.js
    const ctx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Times Booked', data: [], backgroundColor: 'rgba(54,162,235,0.5)', borderColor: 'rgba(54,162,235,1)', borderWidth: 1 }] },
      options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });

    async function loadData() {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error(`Fetch error: ${res.statusText}`);
      const bookings = await res.json();

      // Count per facility
      const counts = bookings.reduce((acc, b) => {
        acc[b.facilityId] = (acc[b.facilityId]||0) + 1;
        return acc;
      }, {});

      // Sort highâ†’low
      const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);

      // Fill table
      const tbody = document.querySelector('#freqTable tbody');
      tbody.innerHTML = '';
      sorted.forEach(([fac,c])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fac}</td><td>${c}</td>`;
        tbody.appendChild(tr);
      });

      // Update chart
      barChart.data.labels = sorted.map(e=>e[0]);
      barChart.data.datasets[0].data = sorted.map(e=>e[1]);
      barChart.update();
    }

    function exportCsv() {
      const rows = [
        ['Facility ID','Times Booked'],
        ...[...document.querySelectorAll('#freqTable tbody tr')]
          .map(tr=>[...tr.children].map(td=>td.textContent))
      ];
      const csv = rows.map(r=>r.map(f=>`"${f.replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'facility-frequency.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function exportChartPng() {
      const canvas = document.getElementById('barChart');
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'facility-frequency-chart.png'; a.click();
    }

    async function exportPdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // 1) Add chart image
      const canvas = document.getElementById('barChart');
      const imgData = canvas.toDataURL('image/png');
      // x=15, y=20, width=180 (maintaining aspect ratio)
      doc.addImage(imgData, 'PNG', 15, 20, 180, canvas.height * (180 / canvas.width));

      // 2) Add table below
      const startY = 20 + (canvas.height * (180 / canvas.width)) + 10;
      const rows = [...document.querySelectorAll('#freqTable tbody tr')]
        .map(tr => [...tr.children].map(td => td.textContent));
      rows.unshift(['Facility ID','Times Booked']);

      doc.autoTable({
        startY,
        head: [rows[0]],
        body: rows.slice(1),
        styles: { fontSize: 10 },
        headStyles: { fillColor: [22,160,133] }
      });

      doc.save('facility-frequency.pdf');
    }

    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
    document.getElementById('exportChartPngBtn').addEventListener('click', exportChartPng);
    document.getElementById('exportPdfBtn').addEventListener('click', exportPdf);

    // initial load
    loadData().catch(err => alert(err));
  </script>
</body>
</html>
